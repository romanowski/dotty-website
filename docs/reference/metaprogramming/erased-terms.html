<html><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><title>Erased Terms</title><link rel="shortcut icon" type="image/x-icon" href="../../../favicon.ico"></link><script type="text/javascript" src="../../../scripts/clipboard.js" defer="true"></script><script type="text/javascript" src="../../../scripts/platform-content-handler.js" defer="true"></script><script type="text/javascript" src="../../../scripts/main.js" defer="true"></script><link rel="stylesheet" href="../../../styles/nord-light.css"></link><link rel="stylesheet" href="../../../styles/scalastyle.css"></link><link rel="stylesheet" href="../../../styles/dotty-icons.css"></link><link rel="stylesheet" href="../../../styles/diagram.css"></link><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><link rel="stylesheet" href="../../../styles/search-bar.css"></link><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><script type="text/javascript" src="../../../scripts/diagram.js" defer="true"></script><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><script type="text/javascript" src="../../../hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="../../../scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="../../../scripts/ux.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/component.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="../../../scripts/data.js" defer="true"></script><script type="text/javascript" src="../../../scripts/fast-navigation-loader.js" defer="true"></script><link rel="stylesheet" href="../../../css/bootstrap.min.css"></link><link rel="stylesheet" href="../../../css/dottydoc.css"></link><link rel="stylesheet" href="../../../css/color-brewer.css"></link><script type="text/javascript" src="../../../js/jquery.min.js" defer="true"></script><script type="text/javascript" src="../../../js/bootstrap.min.js" defer="true"></script><script>var pathToRoot = "../../../";</script></head><body><div id="container"><div id="leftColumn"><div id="logo"><span><img src="../../../project-logo/logo.svg"></img></span><span><div class="projectName">Scala 3</div><div class="projectVersion">3.0.0-M2</div></span></div><div id="paneSearch"></div><nav id="sideMenu"></nav></div><div id="main"><div id="leftToggler"><span class="icon-toggler"></span></div><div id="searchBar"></div><main>
  <div id="content" pageIds="_.docs/reference/metaprogramming/erased-terms.md////PointingToDeclaration//-624007177">
    <div class="breadcrumbs"><a href="../../index.html"></a>/<a href="erased-terms.html">Erased Terms</a></div>
<html>
 <head>
  <link rel="dns-prefetch" href="//fonts.googleapis.com"> 
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css"> 
 </head>
 <body>
  <div id="content-wrapper"> 
   <main class="container"> 
    <header> 
     <h1>"Erased Terms"</h1> 
     <div class="byline"> <a href="https://github.com/lampepfl/dotty/edit/master/docs/docs/reference/metaprogramming/erased-terms.md#L"> <i class="far fa-edit"></i> Edit this page on GitHub </a> 
     </div> 
    </header> 
    <h1><a href="#why-erased-terms" id="why-erased-terms" class="anchor"></a>Why erased terms?</h1> 
    <p>Let's describe the motivation behind erased terms with an example. In the following we show a simple state machine which can be in a state <code>On</code> or <code>Off</code>. The machine can change state from <code>Off</code> to <code>On</code> with <code>turnedOn</code> only if it is currently <code>Off</code>. This last constraint is captured with the <code>IsOff[S]</code> implicit evidence which only exists for <code>IsOff[Off]</code>. For example, not allowing calling <code>turnedOn</code> on in an <code>On</code> state as we would require an evidence of type <code>IsOff[On]</code> that will not be found.</p> 
    <pre><code class="language-scala">sealed trait State
final class On extends State
final class Off extends State

@implicitNotFound("State must be Off")
class IsOff[S &lt;: State]
object IsOff {
  implicit def isOff: IsOff[Off] = new IsOff[Off]
}

class Machine[S &lt;: State] {
  def turnedOn(implicit ev: IsOff[S]): Machine[On] = new Machine[On]
}

val m = new Machine[Off]
m.turnedOn
m.turnedOn.turnedOn // ERROR
//                 ^
//                  State must be Off
</code></pre> 
    <p>Note that in the code above the actual context arguments for <code>IsOff</code> are never used at runtime; they serve only to establish the right constraints at compile time. As these terms are never used at runtime there is not real need to have them around, but they still need to be present in some form in the generated code to be able to do separate compilation and retain binary compatibility. We introduce <em>erased terms</em> to overcome this limitation: we are able to enforce the right constrains on terms at compile time. These terms have no run time semantics and they are completely erased.</p> 
    <h1><a href="#how-to-define-erased-terms" id="how-to-define-erased-terms" class="anchor"></a>How to define erased terms?</h1> 
    <p>Parameters of methods and functions can be declared as erased, placing <code>erased</code> in front of a parameter list (like <code>given</code>).</p> 
    <pre><code class="language-scala">def methodWithErasedEv(erased ev: Ev): Int = 42

val lambdaWithErasedEv: erased Ev =&gt; Int =
 (erased ev: Ev) =&gt; 42
</code></pre> 
    <p><code>erased</code> parameters will not be usable for computations, though they can be used as arguments to other <code>erased</code> parameters.</p> 
    <pre><code class="language-scala">def methodWithErasedInt1(erased i: Int): Int =
  i + 42 // ERROR: can not use i

def methodWithErasedInt2(erased i: Int): Int =
  methodWithErasedInt1(i) // OK
</code></pre> 
    <p>Not only parameters can be marked as erased, <code>val</code> and <code>def</code> can also be marked with <code>erased</code>. These will also only be usable as arguments to <code>erased</code> parameters.</p> 
    <pre><code class="language-scala">erased val erasedEvidence: Ev = ...
methodWithErasedEv(erasedEvidence)
</code></pre> 
    <h1><a href="#what-happens-with-erased-values-at-runtime" id="what-happens-with-erased-values-at-runtime" class="anchor"></a>What happens with erased values at runtime?</h1> 
    <p>As <code>erased</code> are guaranteed not to be used in computations, they can and will be erased.</p> 
    <pre><code class="language-scala">// becomes def methodWithErasedEv(): Int at runtime
def methodWithErasedEv(erased ev: Ev): Int = ...

def evidence1: Ev = ...
erased def erasedEvidence2: Ev = ... // does not exist at runtime
erased val erasedEvidence3: Ev = ... // does not exist at runtime

// evidence1 is not evaluated and no value is passed to methodWithErasedEv
methodWithErasedEv(evidence1)
</code></pre> 
    <h1><a href="#state-machine-with-erased-evidence-example" id="state-machine-with-erased-evidence-example" class="anchor"></a>State machine with erased evidence example</h1> 
    <p>The following example is an extended implementation of a simple state machine which can be in a state <code>On</code> or <code>Off</code>. The machine can change state from <code>Off</code> to <code>On</code> with <code>turnedOn</code> only if it is currently <code>Off</code>, conversely from <code>On</code> to <code>Off</code> with <code>turnedOff</code> only if it is currently <code>On</code>. These last constraint are captured with the <code>IsOff[S]</code> and <code>IsOn[S]</code> given evidence only exist for <code>IsOff[Off]</code> and <code>IsOn[On]</code>. For example, not allowing calling <code>turnedOff</code> on in an <code>Off</code> state as we would require an evidence <code>IsOn[Off]</code> that will not be found.</p> 
    <p>As the given evidences of <code>turnedOn</code> and <code>turnedOff</code> are not used in the bodies of those functions we can mark them as <code>erased</code>. This will remove the evidence parameters at runtime, but we would still evaluate the <code>isOn</code> and <code>isOff</code> givens that were found as arguments. As <code>isOn</code> and <code>isOff</code> are not used except as <code>erased</code> arguments, we can mark them as <code>erased</code>, hence removing the evaluation of the <code>isOn</code> and <code>isOff</code> evidences.</p> 
    <pre><code class="language-scala">import scala.annotation.implicitNotFound

sealed trait State
final class On extends State
final class Off extends State

@implicitNotFound("State must be Off")
class IsOff[S &lt;: State]
object IsOff {
  // will not be called at runtime for turnedOn, the compiler will only require that this evidence exists
  given IsOff[Off] = new IsOff[Off]
}

@implicitNotFound("State must be On")
class IsOn[S &lt;: State]
object IsOn {
  // will not exist at runtime, the compiler will only require that this evidence exists at compile time
  erased given IsOn[On] = new IsOn[On]
}

class Machine[S &lt;: State] private {
  // ev will disappear from both functions
  def turnedOn(using erased ev: IsOff[S]): Machine[On] = new Machine[On]
  def turnedOff(using erased ev: IsOn[S]): Machine[Off] = new Machine[Off]
}

object Machine {
  def newMachine(): Machine[Off] = new Machine[Off]
}

object Test {
  def main(args: Array[String]): Unit = {
    val m = Machine.newMachine()
    m.turnedOn
    m.turnedOn.turnedOff

    // m.turnedOff
    //            ^
    //            State must be On

    // m.turnedOn.turnedOn
    //                    ^
    //                    State must be Off
  }
}
</code></pre> 
    <p>Note that in <a href="./inline.md">Inline</a> we discussed <code>erasedValue</code> and inline matches. <code>erasedValue</code> is implemented with <code>erased</code>, so the state machine above can be encoded as follows:</p> 
    <pre><code class="language-scala">import scala.compiletime._

sealed trait State
final class On extends State
final class Off extends State

class Machine[S &lt;: State] {
  transparent inline def turnOn(): Machine[On] = inline erasedValue[S] match {
    case _: Off  =&gt; new Machine[On]
    case _: On   =&gt; error("Turning on an already turned on machine")
  }
  transparent inline def turnOff(): Machine[Off] = inline erasedValue[S] match {
    case _: On  =&gt; new Machine[Off]
    case _: Off   =&gt; error("Turning off an already turned off machine")
  }
}

object Machine {
  def newMachine(): Machine[Off] = {
    println("newMachine")
    new Machine[Off]
  }
}

object Test {
  val m = Machine.newMachine()
  m.turnOn()
  m.turnOn().turnOff()
  m.turnOn().turnOn() // error: Turning on an already turned on machine
}
</code></pre> 
    <p><a href="./erased-terms-spec.md">More Details</a></p> 
   </main> 
  </div> 
  <script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'lampepfl/dotty'
  };
</script> 
  <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
 </body>
</html>  </div>
</main><footer><span class="go-to-top-icon"><a href="#container"><span class="icon-vertical_align_top"></span>&nbsp;Back to top</a></span>Generated by&nbsp;<a href="https://github.com/lampepfl/dotty/tree/master/scala3doc"><img src="../../../images/scala3doc_logo.svg" alt="Scala3doc" class="scala3doc_logo"></img></a></footer></div></div><script type="text/javascript" src="../../../scripts/pages.js"></script><script type="text/javascript" src="../../../scripts/main.js"></script></body></html>
