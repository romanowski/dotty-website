<html><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><title>Context Functions</title><script type="text/javascript" src="../../../scripts/clipboard.js" defer="true"></script><script type="text/javascript" src="../../../scripts/platform-content-handler.js" defer="true"></script><script type="text/javascript" src="../../../scripts/main.js" defer="true"></script><link rel="stylesheet" href="../../../styles/nord-light.css"></link><link rel="stylesheet" href="../../../styles/scalastyle.css"></link><link rel="stylesheet" href="../../../styles/dotty-icons.css"></link><link rel="stylesheet" href="../../../styles/diagram.css"></link><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><link rel="stylesheet" href="../../../styles/search-bar.css"></link><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><script type="text/javascript" src="../../../scripts/diagram.js" defer="true"></script><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><script type="text/javascript" src="../../../hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="../../../scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="../../../scripts/ux.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/component.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="../../../scripts/data.js" defer="true"></script><script type="text/javascript" src="../../../scripts/fast-navigation-loader.js" defer="true"></script><link rel="stylesheet" href="../../../css/bootstrap.min.css"></link><link rel="stylesheet" href="../../../css/dottydoc.css"></link><link rel="stylesheet" href="../../../css/color-brewer.css"></link><script type="text/javascript" src="../../../js/jquery.min.js" defer="true"></script><script type="text/javascript" src="../../../js/bootstrap.min.js" defer="true"></script><script>var pathToRoot = "../../../";</script></head><body><div id="container"><div id="leftColumn"><div id="logo"></div><div id="paneSearch"></div><nav id="sideMenu"></nav></div><div id="main"><div id="leftToggler"><span class="icon-toggler"></span></div><div id="searchBar"></div><main>
  <div id="content" pageIds="_.docs/reference/contextual/context-functions.md////PointingToDeclaration//-1025483213">
    <div class="breadcrumbs"><a href="../../index.html"></a>/<a href="../../Reference/index.html">Reference</a>/<a href="index.html">Contextual Abstractions</a>/<a href="../-contextual -abstractions/context-functions.html">Context Functions</a></div>
<html>
 <head>
  <link rel="dns-prefetch" href="//fonts.googleapis.com"> 
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css"> 
 </head>
 <body>
  <div id="content-wrapper"> 
   <main class="container"> 
    <header> 
     <h1>"Context Functions"</h1> 
     <div class="byline"> <a href="/edit/master//"> <i class="far fa-edit"></i> Edit this page on GitHub </a> 
     </div> 
    </header> 
    <p><em>Context functions</em> are functions with (only) context parameters. Their types are <em>context function types</em>. Here is an example of a context function type:</p> 
    <pre><code class="language-scala">type Executable[T] = ExecutionContext ?=&gt; T
</code></pre> 
    <p>Context functions are written using <code>?=&gt;</code> as the "arrow" sign. They are applied to synthesized arguments, in the same way methods with context parameters are applied. For instance:</p> 
    <pre><code class="language-scala">  given ec as ExecutionContext = ...

  def f(x: Int): ExecutionContext ?=&gt; Int = ...

  // could be written as follows with the type alias from above
  // def f(x: Int): Executable[Int] = ...

  f(2)(using ec)   // explicit argument
  f(2)             // argument is inferred
</code></pre> 
    <p>Conversely, if the expected type of an expression <code>E</code> is a context function type <code>(T_1, ..., T_n) ?=&gt; U</code> and <code>E</code> is not already an context function literal, <code>E</code> is converted to a context function literal by rewriting it to</p> 
    <pre><code class="language-scala">  (using x_1: T1, ..., x_n: Tn) =&gt; E
</code></pre> 
    <p>where the names <code>x_1</code>, ..., <code>x_n</code> are arbitrary. This expansion is performed before the expression <code>E</code> is typechecked, which means that <code>x_1</code>, ..., <code>x_n</code> are available as givens in <code>E</code>.</p> 
    <p>Like their types, context function literals are written using <code>?=&gt;</code> as the arrow between parameters and results. They differ from normal function literals in that their types are context function types.</p> 
    <p>For example, continuing with the previous definitions,</p> 
    <pre><code class="language-scala">  def g(arg: Executable[Int]) = ...

  g(22)      // is expanded to g((using ev: ExecutionContext) =&gt; 22)

  g(f(2))    // is expanded to g((using ev: ExecutionContext) =&gt; f(2)(using ev))

  g(ExecutionContext ?=&gt; f(3))  // is expanded to g((using ev: ExecutionContext) =&gt; f(3)(using ev))
  g((using ctx: ExecutionContext) =&gt; f(22)(using ctx)) // is left as it is
</code></pre> 
    <h3>Example: Builder Pattern</h3> 
    <p>Context function types have considerable expressive power. For instance, here is how they can support the "builder pattern", where the aim is to construct tables like this:</p> 
    <pre><code class="language-scala">  table {
    row {
      cell("top left")
      cell("top right")
    }
    row {
      cell("bottom left")
      cell("bottom right")
    }
  }
</code></pre> 
    <p>The idea is to define classes for <code>Table</code> and <code>Row</code> that allow the addition of elements via <code>add</code>:</p> 
    <pre><code class="language-scala">  class Table {
    val rows = new ArrayBuffer[Row]
    def add(r: Row): Unit = rows += r
    override def toString = rows.mkString("Table(", ", ", ")")
  }

  class Row {
    val cells = new ArrayBuffer[Cell]
    def add(c: Cell): Unit = cells += c
    override def toString = cells.mkString("Row(", ", ", ")")
  }

  case class Cell(elem: String)
</code></pre> 
    <p>Then, the <code>table</code>, <code>row</code> and <code>cell</code> constructor methods can be defined with context function types as parameters to avoid the plumbing boilerplate that would otherwise be necessary.</p> 
    <pre><code class="language-scala">  def table(init: Table ?=&gt; Unit) = {
    given t as Table // note the use of a creator application; same as: given t as Table = new Table
    init
    t
  }

  def row(init: Row ?=&gt; Unit)(using t: Table) = {
    given r as Row
    init
    t.add(r)
  }

  def cell(str: String)(using r: Row) =
    r.add(new Cell(str))
</code></pre> 
    <p>With that setup, the table construction code above compiles and expands to:</p> 
    <pre><code class="language-scala">  table { (using $t: Table) =&gt;

    row { (using $r: Row) =&gt;
      cell("top left")(using $r)
      cell("top right")(using $r)
    }(using $t)

    row { (using $r: Row) =&gt;
      cell("bottom left")(using $r)
      cell("bottom right")(using $r)
    }(using $t)
  }
</code></pre> 
    <h3>Example: Postconditions</h3> 
    <p>As a larger example, here is a way to define constructs for checking arbitrary postconditions using an extension method <code>ensuring</code> so that the checked result can be referred to simply by <code>result</code>. The example combines opaque type aliases, context function types, and extension methods to provide a zero-overhead abstraction.</p> 
    <pre><code class="language-scala">object PostConditions {
  opaque type WrappedResult[T] = T

  def result[T](using r: WrappedResult[T]): T = r

  extension [T](x: T) def ensuring(condition: WrappedResult[T] ?=&gt; Boolean): T = {
    assert(condition(using x))
    x
  }
}
import PostConditions.{ensuring, result}

val s = List(1, 2, 3).sum.ensuring(result == 6)
</code></pre> 
    <p><strong>Explanations</strong>: We use a context function type <code>WrappedResult[T] ?=&gt; Boolean</code> as the type of the condition of <code>ensuring</code>. An argument to <code>ensuring</code> such as <code>(result == 6)</code> will therefore have a given of type <code>WrappedResult[T]</code> in scope to pass along to the <code>result</code> method. <code>WrappedResult</code> is a fresh type, to make sure that we do not get unwanted givens in scope (this is good practice in all cases where context parameters are involved). Since <code>WrappedResult</code> is an opaque type alias, its values need not be boxed, and since <code>ensuring</code> is added as an extension method, its argument does not need boxing either. Hence, the implementation of <code>ensuring</code> is as about as efficient as the best possible code one could write by hand:</p> 
    <pre><code class="language-scala">{ val result = List(1, 2, 3).sum
  assert(result == 6)
  result
}
</code></pre> 
    <h3>Reference</h3> 
    <p>For more info, see the <a href="https://www.scala-lang.org/blog/2016/12/07/implicit-function-types.html">blog article</a>, (which uses a different syntax that has been superseded).</p> 
    <p><a href="./context-functions-spec.md">More details</a></p> 
   </main> 
  </div> 
  <script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'lampepfl/dotty'
  };
</script> 
  <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
 </body>
</html>  </div>
</main><footer><span class="go-to-top-icon"><a href="#container"><span class="icon-vertical_align_top"></span>&nbsp;Back to top</a></span><span class="pull-right">Generated by&nbsp;<a href="https://github.com/lampepfl/scala3doc">Scala3doc</a></span></footer></div></div><script type="text/javascript" src="../../../scripts/pages.js"></script><script type="text/javascript" src="../../../scripts/main.js"></script></body></html>
