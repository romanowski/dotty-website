<html><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><title>TASTy Reflect</title><script type="text/javascript" src="../../../scripts/clipboard.js" defer="true"></script><script type="text/javascript" src="../../../scripts/platform-content-handler.js" defer="true"></script><script type="text/javascript" src="../../../scripts/main.js" defer="true"></script><link rel="stylesheet" href="../../../styles/nord-light.css"></link><link rel="stylesheet" href="../../../styles/scalastyle.css"></link><link rel="stylesheet" href="../../../styles/dotty-icons.css"></link><link rel="stylesheet" href="../../../styles/diagram.css"></link><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><link rel="stylesheet" href="../../../styles/search-bar.css"></link><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><script type="text/javascript" src="../../../scripts/diagram.js" defer="true"></script><link rel="stylesheet" href="../../../styles/filter-bar.css"></link><script type="text/javascript" src="../../../hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="../../../scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="../../../scripts/ux.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/component.js" defer="true"></script><script type="text/javascript" src="../../../scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="../../../scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="../../../scripts/data.js" defer="true"></script><script type="text/javascript" src="../../../scripts/fast-navigation-loader.js" defer="true"></script><link rel="stylesheet" href="../../../css/bootstrap.min.css"></link><link rel="stylesheet" href="../../../css/dottydoc.css"></link><link rel="stylesheet" href="../../../css/color-brewer.css"></link><script type="text/javascript" src="../../../js/jquery.min.js" defer="true"></script><script type="text/javascript" src="../../../js/bootstrap.min.js" defer="true"></script><script>var pathToRoot = "../../../";</script></head><body><div id="container"><div id="leftColumn"><div id="logo"></div><div id="paneSearch"></div><nav id="sideMenu"></nav></div><div id="main"><div id="leftToggler"><span class="icon-toggler"></span></div><div id="searchBar"></div><main>
  <div id="content" pageIds="_.docs/reference/metaprogramming/tasty-reflect.md////PointingToDeclaration//-1025483213">
    <div class="breadcrumbs"><a href="../../index.html"></a>/<a href="../../Reference/index.html">Reference</a>/<a href="index.html">Metaprogramming</a>/<a href="../-metaprogramming/tasty-reflect.html">TASTy Reflect</a></div>
<html>
 <head>
  <link rel="dns-prefetch" href="//fonts.googleapis.com"> 
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css"> 
 </head>
 <body>
  <div id="content-wrapper"> 
   <main class="container"> 
    <header> 
     <h1>"TASTy Reflect"</h1> 
     <div class="byline"> <a href="/edit/master//"> <i class="far fa-edit"></i> Edit this page on GitHub </a> 
     </div> 
    </header> 
    <p>TASTy Reflect enables inspection and construction of Typed Abstract Syntax Trees (Typed-AST). It may be used on quoted expressions (<code>quoted.Expr</code>) and quoted types (<code>quoted.Type</code>) from <a href="./macros.md">Macros</a> or on full TASTy files.</p> 
    <p>If you are writing macros, please first read <a href="./macros.md">Macros</a>. You may find all you need without using TASTy Reflect.</p> 
    <h2>API: From quotes and splices to TASTy reflect trees and back</h2> 
    <p>With <code>quoted.Expr</code> and <code>quoted.Type</code> we can compute code but also analyze code by inspecting the ASTs. <a href="./macros.md">Macros</a> provide the guarantee that the generation of code will be type-correct. Using TASTy Reflect will break these guarantees and may fail at macro expansion time, hence additional explicit checks must be done.</p> 
    <p>To provide reflection capabilities in macros we need to add an implicit parameter of type <code>scala.quoted.QuoteContext</code> and import <code>qctx.reflect._</code> from it in the scope where it is used.</p> 
    <pre><code class="language-scala">import scala.quoted._

inline def natConst(inline x: Int): Int = ${natConstImpl('{x})}

def natConstImpl(x: Expr[Int])(using qctx: QuoteContext): Expr[Int] = {
  import qctx.reflect._
  ...
}
</code></pre> 
    <h3>Extractors</h3> 
    <p><code>import qctx.reflect._</code> will provide all extractors and methods on TASTy Reflect trees. For example the <code>Literal(_)</code> extractor used below.</p> 
    <pre><code class="language-scala">def natConstImpl(x: Expr[Int])(using qctx: QuoteContext): Expr[Int] = {
  import qctx.reflect._
  val xTree: Term = Term.of(x)
  xTree match {
    case Inlined(_, _, Literal(Constant(n: Int))) =&gt;
      if (n &lt;= 0) {
        Reporting.error("Parameter must be natural number")
        '{0}
      } else {
        xTree.asExprOf[Int]
      }
    case _ =&gt;
      Reporting.error("Parameter must be a known constant")
      '{0}
  }
}
</code></pre> 
    <p>To easily know which extractors are needed, the <code>showExtractors</code> method on a <code>qctx.reflect.Term</code> returns the string representation of the extractors.</p> 
    <p>The methods <code>qctx.reflect.Term.{asExpr, asExprOf}</code> provide a way to go back to a <code>quoted.Expr</code>. Note that <code>asExpr</code> returns a <code>Expr[Any]</code>. On the other hand <code>asExprOf[T]</code> returns a <code>Expr[T]</code>, if the type does not conform to it an exception will be thrown at runtime.</p> 
    <h3>Positions</h3> 
    <p>The <code>ast</code> in the context provides a <code>rootPosition</code> value. It corresponds to the expansion site for macros. The macro authors can obtain various information about that expansion site. The example below shows how we can obtain position information such as the start line, the end line or even the source code at the expansion point.</p> 
    <pre><code class="language-scala">def macroImpl()(qctx: QuoteContext): Expr[Unit] = {
  import qctx.reflect._
  val pos = rootPosition

  val path = pos.sourceFile.jpath.toString
  val start = pos.start
  val end = pos.end
  val startLine = pos.startLine
  val endLine = pos.endLine
  val startColumn = pos.startColumn
  val endColumn = pos.endColumn
  val sourceCode = pos.sourceCode
  ...
</code></pre> 
    <h3>Tree Utilities</h3> 
    <p><code>scala.tasty.reflect</code> contains three facilities for tree traversal and transformation.</p> 
    <p><code>TreeAccumulator</code> ties the knot of a traversal. By calling <code>foldOver(x, tree))</code> we can dive into the <code>tree</code> node and start accumulating values of type <code>X</code> (e.g., of type List[Symbol] if we want to collect symbols). The code below, for example, collects the pattern variables of a tree.</p> 
    <pre><code class="language-scala">def collectPatternVariables(tree: Tree)(implicit ctx: Context): List[Symbol] = {
  val acc = new TreeAccumulator[List[Symbol]] {
    def apply(syms: List[Symbol], tree: Tree)(implicit ctx: Context) = tree match {
      case Bind(_, body) =&gt; apply(tree.symbol :: syms, body)
      case _ =&gt; foldOver(syms, tree)
    }
  }
  acc(Nil, tree)
}
</code></pre> 
    <p>A <code>TreeTraverser</code> extends a <code>TreeAccumulator</code> and performs the same traversal but without returning any value. Finally a <code>TreeMap</code> performs a transformation.</p> 
    <h4>Let</h4> 
    <p><code>scala.tasty.Reflection</code> also offers a method <code>let</code> that allows us to bind the <code>rhs</code> (right-hand side) to a <code>val</code> and use it in <code>body</code>. Additionally, <code>lets</code> binds the given <code>terms</code> to names and allows to use them in the <code>body</code>. Their type definitions are shown below:</p> 
    <pre><code class="language-scala">def let(rhs: Term)(body: Ident =&gt; Term): Term = ...

def lets(terms: List[Term])(body: List[Term] =&gt; Term): Term = ...
</code></pre> 
    <h2>More Examples</h2> 
    <ul> 
     <li>Start experimenting with TASTy Reflect (<a href="https://github.com/nicolasstucki/tasty-reflection-exercise">link</a>)</li> 
    </ul> 
   </main> 
  </div> 
  <script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'lampepfl/dotty'
  };
</script> 
  <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>
 </body>
</html>  </div>
</main><footer><span class="go-to-top-icon"><a href="#container"><span class="icon-vertical_align_top"></span>&nbsp;Back to top</a></span><span class="pull-right">Generated by&nbsp;<a href="https://github.com/lampepfl/scala3doc">Scala3doc</a></span></footer></div></div><script type="text/javascript" src="../../../scripts/pages.js"></script><script type="text/javascript" src="../../../scripts/main.js"></script></body></html>
